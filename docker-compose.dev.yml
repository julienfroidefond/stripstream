version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stripstream-app
    ports:
      - "3020:3000"
    volumes:
      - ./src:/app/src
      - ./prisma:/app/prisma
      - ./public:/app/public
      - ./package.json:/app/package.json
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ./tsconfig.json:/app/tsconfig.json
      - ./tailwind.config.ts:/app/tailwind.config.ts
      - ./postcss.config.js:/app/postcss.config.js
      - ./next.config.js:/app/next.config.js
      - /app/node_modules
      - /app/.next
      - ~/.pnpm-store:/app/.pnpm-store
      - cache_data:/app/.cache
      - sqlite_data:/app/data
    environment:
      - NODE_ENV=development
      - DATABASE_URL=file:/app/data/stripstream.db
      - PNPM_HOME=/app/.pnpm-store
      - WATCHPACK_POLLING=true
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - CACHE_DEBUG=true
      - KOMGA_MAX_CONCURRENT_REQUESTS=5
    command: sh -c "pnpm config set store-dir /app/.pnpm-store && pnpm install --frozen-lockfile && pnpm prisma generate && pnpm dev"

volumes:
  sqlite_data:
  cache_data:
